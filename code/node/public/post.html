<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>post title</title>
    <link rel="stylesheet" href="/stylesheets/github-markdown.css" />
</head>
<body>
    <h1>标题</h1>
    <ul>
        <li><a href="http://www.baidu.com" class="btn-delete">删除</a></li>
        <li><a class="btn-edit" href="#">编辑</a></li>
    </ul>
    <div class="markdown-body">
        内容
    </div>
    <script type="text/javascript" charset="utf-8">
        //获取查询字符串并转换成数组
        var arrQuery = window.location.search
            .replace('?', '')
            .split('&');
        //保存处理好的查询参数键值对
        var queryParams = {};
        //ajax请求地址
        var strUrl = '';

        var xhr = new XMLHttpRequest();
        var divElm = document.querySelector('div')
        var titleEml = document.querySelector('h1')

        //格式化参数列表
        arrQuery.forEach((item, index, list) => {
            var tmpArr = item.split('=');

            queryParams[tmpArr[0]] = tmpArr[1]
        })
        strUrl = `/post?p=${queryParams.p}`;

        titleEml.innerText = decodeURIComponent(queryParams.p);

        //向服务器请求日志内容
        xhr.open('GET', strUrl);
        xhr.send(null);
        xhr.onreadystatechange = (rst) => {
            var rst = null;
            if(xhr.readyState === 4){
                rst = JSON.parse(xhr.responseText);
                console.log(rst);
                if(rst.success){
                    divElm.innerHTML = rst.data.strHtml;
                }else{
                    alert(rst.errorMessage)
                }
            }
        }

    //获取删除链接
    var btnDelete = document.querySelector('.btn-delete');
    btnDelete.addEventListener('click', function(e){
        //阻止a元素的默认事件
        e.preventDefault();

        //获取XMLHttpRequest的实例
        var xhr = new XMLHttpRequest();

        //open(method-http方法, url-后端服务地址)
        xhr.open('DELETE', '/post');
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        //send(要提交到后端的数据)
        xhr.send( `p=${queryParams.p}` )

        //绑定ajax回调函数
        xhr.onreadystatechange = function(){
            var rst = null;
            //收到服务器响应
            if(xhr.readyState === 4){
                //把服务器返回的东西转换成对象并保存到变量rst里
                rst = JSON.parse(xhr.responseText);
                if(rst.success){
                    location.pathname = '/list.html';
                }else{
                    alert('删除失败')
                }
            }
        }
    })


    //设置编辑的url
    var linkUrl = '/edit.html?p=' + queryParams.p;
    var editLinkElm = document.querySelector('.btn-edit')
    editLinkElm.href = linkUrl;
    </script>
</body>
</html>
